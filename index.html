<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <link rel="stylesheet" href="styles.css" />
    <title>Map</title>
  </head>
<body>
  <div id="map"></div>
  
  <form id="newPlaceForm" class="hidden">
    <label for="name">Name:</label>
    <input type="text" id="name" name="name" required><br>
  
    <label for="description">Description:</label>
    <textarea id="description" name="description" required></textarea><br>
  
    <label for="latitude">Latitude:</label>
    <input type="text" id="latitude" name="latitude" required><br>
  
    <label for="longitude">Longitude:</label>
    <input type="text" id="longitude" name="longitude" required><br>
  
    <button type="submit">Add Place</button>
  </form>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
  <script src="api.js"></script>
  <script>
    let map;
    let markers = {};

    function deletePlace(id) {
      fetch(`http://localhost:3000/places/${id}`, {
        method: 'DELETE'
      })
        .then(response => {
          if (response.ok) {
            if (markers.hasOwnProperty(id)) {
              map.removeLayer(markers[id]);
              delete markers[id];
            }
          } else {
            throw new Error('Failed to delete place');
          }
        })
        .catch(error => {
          console.error(error);
        });
    }

    function editPlace(id) {
      const marker = markers[id];
      const popupContent = `
        <form id="editPlaceForm" onsubmit="savePlace(${id}); return false;">
          <label for="editName">Name:</label>
          <input type="text" id="editName" name="editName" value="${marker.options.name}" required><br>
      
          <label for="editDescription">Description:</label>
          <textarea id="editDescription" name="editDescription" required>${marker.options.description}</textarea><br>
      
          <button type="submit">Save</button>
          <button onclick="cancelEditPlace(${id})">Cancel</button>
        </form>
      `;
      marker.setPopupContent(popupContent);
    }

    function cancelEditPlace(id) {
      const marker = markers[id];
      const popupContent = `
        <b>${marker.options.name}</b><br>
        ${marker.options.description}<br>
        <button onclick="editPlace(${id})">Edit</button>
        <button onclick="deletePlace(${id})">Delete</button>
      `;
      marker.setPopupContent(popupContent);
    }

    function savePlace(id) {
      const marker = markers[id];
      const newName = document.getElementById('editName').value;
      const newDescription = document.getElementById('editDescription').value;
      
      marker.options.name = newName;
      marker.options.description = newDescription;

      const popupContent = `
        <b>${newName}</b><br>
        ${newDescription}<br>
        <button onclick="editPlace(${id})">Edit</button>
        <button onclick="deletePlace(${id})">Delete</button>
      `;
      marker.setPopupContent(popupContent);
    }
  
    document.addEventListener('DOMContentLoaded', () => {
      map = L.map('map').setView([50.4501, 30.5234], 7);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      const customIcon = L.icon({
        iconUrl: 'images/marker.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
      });

      map.on('click', (event) => {
        const latitude = event.latlng.lat.toFixed(6);
        const longitude = event.latlng.lng.toFixed(6);

        document.getElementById('latitude').value = latitude;
        document.getElementById('longitude').value = longitude;
        document.getElementById('newPlaceForm').classList.remove('hidden');
      });

      fetch('http://localhost:3000/places')
        .then(response => response.json())
        .then(places => {
          places.forEach(place => {
            const marker = L.marker([place.latitude, place.longitude], { icon: customIcon, name: place.name, description: place.description }).addTo(map);
            marker.bindPopup(`
              <b>${place.name}</b><br>
              ${place.description}<br>
              <button onclick="editPlace(${place.id})">Edit</button>
              <button onclick="deletePlace(${place.id})">Delete</button>
            `);
            markers[place.id] = marker;
          });
        })
        .catch(error => console.error(error));

        const form = document.getElementById('newPlaceForm');
      map.on('click', () => {
        form.classList.remove('hidden');
      });

      form.addEventListener('submit', (event) => {
        event.preventDefault();

        const name = document.getElementById('name').value;
        const description = document.getElementById('description').value;
        const latitude = parseFloat(document.getElementById('latitude').value);
        const longitude = parseFloat(document.getElementById('longitude').value);

        const newPlace = {
          name: name,
          description: description,
          latitude: latitude,
          longitude: longitude
        };

        fetch('http://localhost:3000/places', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(newPlace)
        })
          .then(response => {
            if (response.ok) {
              return response.json();
            } else {
              throw new Error('Failed to add place');
            }
          })
          .then(result => {
            const marker = L.marker([latitude, longitude], { icon: customIcon, id: result.id, name: name, description: description }).addTo(map);
            marker.bindPopup(`
              <b>${name}</b><br>
              ${description}<br>
              <button onclick="editPlace(${result.id})">Edit</button>
              <button onclick="deletePlace(${result.id})">Delete</button>
            `);
            markers[result.id] = marker;

            form.reset();
            form.classList.add('hidden');
          })
          .catch(error => {
            console.error(error);
          });
      });
    });
  </script>
</body>
</html>
